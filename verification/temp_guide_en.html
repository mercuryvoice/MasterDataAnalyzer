<!--
// @ts-check

// =================================================================================================
// =================================== VERSION & FEATURE SUMMARY ===================================
// =================================================================================================
//
// V1.0 (Pre-release version):
// - Noted.
//
// =================================================================================================
-->

<!--
/**
 * MasterDataAnalyzer - A Google Sheets Add-on for intelligent data operations.
 *
 * Copyright (c) 2025 Tata Sum (mda.design)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by

 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
 */
-->
<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            padding: 1rem;
            background-color: #f8fafc;
            color: #334155;
        }
        .step-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1.25rem;
            transition: opacity 0.5s ease-in-out;
        }
        .step-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
        }
        .step-instruction {
            margin-top: 0.75rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .step-instruction code {
            background-color: #e2e8f0;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
            color: #475569;
        }
        .progress-bar-bg {
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 0.5rem;
            overflow: hidden;
        }
        .progress-bar-fg {
            background-color: #3b82f6;
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .nav-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .choice-button {
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s;
            width: 100%;
        }
        #step-selector {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body>
    <div id="tutorial-container" class="space-y-4">
        <div>
            <p id="progress-text" class="text-sm font-medium text-slate-500 mb-1"></p>
            <div class="progress-bar-bg">
                <div id="progress-bar" class="progress-bar-fg"></div>
            </div>
        </div>

        <div class="mt-2">
            <select id="step-selector" class="w-full p-2 border border-slate-300 rounded-md bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </select>
        </div>

        <div id="step-content" class="step-card">
        </div>

        <div id="nav-buttons" class="flex justify-between items-center pt-2">
            <button id="prev-btn" class="nav-button bg-slate-200 hover:bg-slate-300 text-slate-700"></button>
            <button id="next-btn" class="nav-button bg-blue-600 hover:bg-blue-700 text-white"></button>
        </div>

        <div id="loading-indicator" class="mt-3 hidden transition-opacity duration-300">
            <div class="flex justify-between items-center mb-1">
                <span id="loading-text" class="text-xs font-medium text-slate-500"></span>
                <span id="loading-percent" class="text-xs font-medium text-slate-500">0%</span>
            </div>
            <div class="h-1 w-full bg-slate-100 rounded-full overflow-hidden">
                <div id="loading-bar" class="h-full bg-blue-500 transition-all duration-300 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let loadingInterval;
        let tutorialSteps = [];
        let T;
        let checkpointIndex = -1;
        let checkpoint2Index = -1;
        let businessCheckpoint2Index = -1;
        const tutorialType = "business";

        try {
            T = JSON.parse('{"tutorialPrev": "Previous", "tutorialNext": "Next", "tutorialClose": "Close", "tutorialYes": "Yes, continue", "tutorialNo": "No, I\'m done for now", "tutorialProgressText": "Step {CURRENT} / {TOTAL}", "endTutorialTitle": "Tutorial Paused", "endTutorialInstruction": "Great! You have completed the \'Data Import\' section.\nYou can reopen this tutorial at any time or continue exploring other features.", "endTutorialReturnButton": "Return to \'Task 1 Complete\' step", "businessReturnToStep13": "Return to Step 13 Congratulations, Analysis Complete!", "businessWelcomeTitle": "Welcome! (Business & Sales)", "businessWelcomeInstruction": "Welcome to the interactive tutorial for the <code>Business & Sales Example</code>.\n\nOur goal is to transform an incomplete sales record into a complete analysis report using the features of MasterDataAnalyzer.\n\nClick <code>Next</code> to start our first task!", "businessTask1Step1Title": "Task 1: Data Import (1/6)", "businessTask1Step1Instruction": "First, please ensure you have activated the <code>{SHEET_NAME}</code> sheet.\n\nOur goal is to filter and import sales records from <code>{SOURCE_SHEET_NAME}</code> into the current dashboard.", "businessTask1Step2Title": "Task 1: Data Import (2/6)", "businessTask1Step2Instruction": "Please click on <code>MasterDataAnalyzer > Data Import Tool > \u2699\ufe0f Data Import Settings</code> in the top menu.", "businessTask1Step3Title": "Task 1: Data Import (3/6)", "businessTask1Step3Instruction": "In the settings window, please configure the following:\n1. <code>Source Data Select</code>: Click the <code>Select</code> button and choose the current spreadsheet file from the file picker.\n2. <code>Source Data Sheet Name</code>: Select <code>{SOURCE_SHEET_NAME}</code>\n3. <code>Target Data Sheet Name</code>: Should be auto-filled with <code>{TARGET_SHEET_NAME}</code>", "businessTask1Step4Title": "Task 1: Data Import (4/6)", "businessTask1Step4Instruction": "Next, set the data ranges:\n1. <code>Header Start Row for Data Import</code>: <code>1</code>\n2. <code>Data Import Start Row</code>: <code>2</code>\n3. <code>Source Data Import Range</code>: <code>A2:E9</code>", "businessTask1Step5Title": "Task 1: Data Import (5/6)", "businessTask1Step5Instruction": "Please add a filter condition:<br>1. <code>Header Name</code>: <br>Customer ID<br>2. <code>Keywords</code>: <br>Click <code>Select</code> then check <code>Select All</code><br>Reminder: It is recommended to import all data here to facilitate the application of report generation later.<br><br>In <code>Source Header Import Range Settings</code>, you can enter a header range to limit the scope of header detection. If left blank, all headers will be used by default.", "businessTask1Step6Title": "Task 1: Data Import (6/6)", "businessTask1Step6Instruction": "Great! All settings are complete.\n\nPlease click <code>Save Settings</code>, close the window, and then run <code>MasterDataAnalyzer > Data Import Tool > \u25b6\ufe0f Run Import</code> from the menu.", "businessCheckpointTitle": "Task 1 Complete!", "businessCheckpointInstruction": "Congratulations! You have successfully imported the raw data into the dashboard.\n\nWould you like to continue learning about the next core feature, <code>Data Validation</code>?", "businessTask2Step1Title": "Task 2: Enrich Customer Data (1/3)", "businessTask2Step1Instruction": "Excellent! The dashboard now has raw data but lacks detailed customer information.\n\nNext, we\'ll use the <code>Data Comparison</code> feature to look up and fill in customer data from the <code>Source | Customer List</code>.\n\nOpen <code>Data Import Tool > \u2699\ufe0f Data Comparison Settings</code> and begin configuring Task 2:", "businessTask2Step2Title": "Task 2: Enrich Customer Data (2/3)", "businessTask2Step2Instruction": "Please apply the following settings:\n1. <code>Source Sheets</code>: Choose <code>Source Data Sheet Name</code> as <code>{SOURCE_SHEET_NAME}</code> and <code>Target Data Sheet Name</code> as <code>{TARGET_SHEET_NAME}</code>.\n2. <code>Ranges</code>: Set <code>Target Data Start Row</code> to <code>2</code> and <code>Source Data Compare Range</code> to <code>A2:D6</code>.\n3. <code>Field Mapping</code>: Set up the fields in the following order:\n  - <code>Target Lookup Column</code>: <code>B</code> (Customer ID)\n  - <code>Source Compare Column</code>: <code>A</code> (Customer ID)\n  - <code>Source Return Column</code>: <code>B</code> (Customer Name)\n  - <code>Target Write Column</code>: <code>C</code> (Customer Name)", "businessTask2Step3Title": "Task 2: Enrich Customer Data (3/3)", "businessTask2Step3Instruction": "After saving the settings, run <code>MasterDataAnalyzer > Data Import Tool > \u25b6\ufe0f Run Data Comparison</code>.\n\nYou will see the customer names have been successfully imported. Repeat this process to also fill in the <code>Region</code> and <code>Salesperson</code> to complete the dashboard.", "businessTask3Step1Title": "Task 3: Compare Sales Targets (1/2)", "businessTask3Step1Instruction": "The dashboard data is becoming more complete! For the final step, let\'s compare the sales targets for each product.\n\nPlease open the <code>Data Comparison Settings</code> again.", "businessTask3Step2Title": "Task 3: Compare Sales Targets (2/2)", "businessTask3Step2Instruction": "This time, use <code>Product Name</code> as the lookup key and select <code>\"Source | Product Targets\"</code> as the source sheet.<br>Set the <code>Source Data Compare Range</code> to <code>A2:B5</code>, and configure the field mapping as follows:<br>  - <code>Target Lookup Column</code>: <code>F</code> (Product Name)<br>  - <code>Source Compare Column</code>: <code>A</code> (Product Name)<br>  - <code>Source Return Column</code>: <code>B</code> (Monthly Target)<br>  - <code>Target Write Column</code>: <code>J</code> (Monthly Target)", "businessFinalStepTitle": "Congratulations, Analysis Complete!", "businessFinalStepInstruction": "Then, run the <code>Data Comparison</code> again.\n\nAll data is now in place! You now have a clean, complete dataset ready for analysis.\n\nNext, you can manually enter or click the button below to insert formulas in the corresponding columns to complete the final calculations:\n- **Total Sales**: <code>=H2*I2</code> (Quantity * Unit Price)\n- **Achievement Rate**: <code>=G2/J2</code> (Total Sales / Monthly Target)", "businessFinalStepButton": "Insert Formulas Automatically", "businessProcessingButton": "Processing...", "businessSuccessButton": "Formulas Inserted!", "businessErrorButton": "Error, please retry", "businessCheckpoint2Title": "Task 4: Data Report Generation Settings!", "businessCheckpoint2Instruction": "Congratulations! You have successfully transformed the raw data into an analyzable dashboard with the help of MasterDataAnalyzer.\n\nWould you like to continue learning about the next core feature, \'Data Report Generation Settings\'?", "businessTask4Step1Title": "Task 4: Data Report Generation Settings (1/4)", "businessTask4Step1Instruction": "Please click on <code>MasterDataAnalyzer > Data Management Tool > \u2699\ufe0f Report Generation Settings</code> in the top menu.", "businessTask4Step2Title": "Task 4: Report Data Source Settings (2/4)", "businessTask4Step2Instruction": "In the settings window, please configure the following:\n1. <code>Source Data Select</code>: Click the <code>Select</code> button and choose the current spreadsheet file from the file picker.\n2. <code>Source Data Sheet Name</code>: Select <code>{SHEET_NAME}</code>\n3. <code>Source Data Import Range</code>: Please enter the data range to be analyzed from <code>{SHEET_NAME}</code>, for example: <code>A1:K9</code>", "businessTask4Step3Title": "Task 4: Report Field Mapping Settings (3/4)", "businessTask4Step3Instruction": "1. To generate a report, at least one combination of a dimension (Y) and a metric (X) is required. You can click <code>+Add Analysis Field</code> to map multiple sets for numerical analysis.<br>2. You can follow the example settings:<br><strong>First Set</strong>: Dimension <code>Customer Name</code>, Metric <code>Total Sales</code><br><strong>Second Set</strong>: Dimension <code>Product Name</code>, Metric <code>Monthly Target</code><br><strong>Third Set</strong>: Dimension <code>Salesperson</code>, Metric <code>Achievement Rate</code><br>3. Click <code>Save Settings</code>, then click <code>Generate Report</code>.", "businessTask4Step4Title": "Task 4: Generate and Export Report (4/4)", "businessTask4Step4Instruction": "Great, you should now see the generated chart report with multiple dimensions and metrics. Please click <code>Confirm Export</code> to generate the report in a new Google Sheet tab.", "businessFinal2StepTitle": "Congratulations, Tutorial Complete!", "businessFinal2StepInstruction": "Congratulations, you have completed the interactive tutorial for report generation and export!<br>MasterDataAnalyzer has successfully exported the report for you. You can go to the new Google Sheet tab to view or start editing the native report.", "exampleDashboardSheet_Sales": "Dashboard | Sales Analysis", "exampleSalesLogSheet_Sales": "Source | Sales Log", "exampleCustomerMasterSheet_Sales": "Source | Customer List", "exampleProductTargetsSheet_Sales": "Source | Product Targets", "productLaptop": "High-Performance Laptop", "headerProductName": "Product Name"}');
        } catch (e) {
            console.error("無法解析翻譯資料:", e);
            T = { tutorialPrev: "Previous", tutorialNext: "Next", tutorialClose: "Close", tutorialYes: "Yes", tutorialNo: "No", tutorialProgressText: "Step {CURRENT} / {TOTAL}" };
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeTutorial();

            document.getElementById('next-btn').addEventListener('click', () => {
                const step = tutorialSteps[currentStep];
                if (step && step.isFinal) {
                    google.script.host.close();
                    return;
                }
                if (currentStep < tutorialSteps.length - 1) {
                    currentStep++;
                    renderStep(currentStep);
                }
            });

            document.getElementById('prev-btn').addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    renderStep(currentStep);
                }
            });

            document.getElementById('step-selector').addEventListener('change', (event) => {
                const newStep = parseInt(event.target.value, 10);
                if (!isNaN(newStep) && newStep !== currentStep) {
                    currentStep = newStep;
                    renderStep(currentStep);
                }
            });
        });

        function initializeTutorial() {
            document.getElementById('prev-btn').textContent = T.tutorialPrev;
            document.getElementById('next-btn').textContent = T.tutorialNext;

            defineTutorialSteps();
            populateStepSelector();
            renderStep(currentStep);
        }

        function populateStepSelector() {
            const selector = document.getElementById('step-selector');
            selector.innerHTML = '';
            tutorialSteps.forEach((step, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = step.title;
                selector.appendChild(option);
            });
        }

        function defineTutorialSteps() {
            if (tutorialType === 'business') {
                defineBusinessSteps();
            } else if (tutorialType === 'manufacturing') {
                defineManufacturingSteps();
            }
        }

        function defineBusinessSteps() {
            const importSteps = [
                { title: T.businessWelcomeTitle, instruction: T.businessWelcomeInstruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } },
                { title: T.businessTask1Step1Title, instruction: T.businessTask1Step1Instruction.replace('{SHEET_NAME}', T.exampleDashboardSheet_Sales).replace('{SOURCE_SHEET_NAME}', T.exampleSalesLogSheet_Sales), action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } },
                { title: T.businessTask1Step2Title, instruction: T.businessTask1Step2Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } },
                { title: T.businessTask1Step3Title, instruction: T.businessTask1Step3Instruction.replace('{SOURCE_SHEET_NAME}', T.exampleSalesLogSheet_Sales).replace('{TARGET_SHEET_NAME}', T.exampleDashboardSheet_Sales), action: { func: 'tutorial_highlightSheet', args: [T.exampleSalesLogSheet_Sales] } },
                { title: T.businessTask1Step4Title, instruction: T.businessTask1Step4Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleSalesLogSheet_Sales] } },
                { title: T.businessTask1Step5Title, instruction: T.businessTask1Step5Instruction.replace(/{PRODUCT_NAME}/g, T.productLaptop).replace('{HEADER_NAME}', T.headerProductName), action: { func: 'tutorial_highlightSheet', args: [T.exampleSalesLogSheet_Sales] } },
                { title: T.businessTask1Step6Title, instruction: T.businessTask1Step6Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } }
            ];
            const checkpointStep = { isCheckpoint: true, title: T.businessCheckpointTitle, instruction: T.businessCheckpointInstruction, action: { func: 'tutorial_highlightRange', args: [T.exampleDashboardSheet_Sales, "C:E"] } };
            tutorialSteps = [...importSteps, checkpointStep];
            checkpointIndex = tutorialSteps.findIndex(step => step.isCheckpoint);
        }

        function defineManufacturingSteps() {
             const importSteps = [
                { title: T.mfgWelcomeTitle, instruction: T.mfgWelcomeInstruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } },
                { title: T.mfgTask1Step1Title, instruction: T.mfgTask1Step1Instruction.replace('{SHEET_NAME}', T.exampleTargetSheet).replace('{SOURCE_SHEET_NAME}', T.exampleImportSourceSheet), action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } },
                { title: T.mfgTask1Step2Title, instruction: T.mfgTask1Step2Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } },
                { title: T.mfgTask1Step3Title, instruction: T.mfgTask1Step3Instruction.replace('{SOURCE_SHEET_NAME}', T.exampleImportSourceSheet).replace('{TARGET_SHEET_NAME}', T.exampleTargetSheet), action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } },
                { title: T.mfgTask1Step4Title, instruction: T.mfgTask1Step4Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleImportSourceSheet] } },
                { title: T.mfgTask1Step5Title, instruction: T.mfgTask1Step5Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleImportSourceSheet] } },
                { title: T.mfgTask1Step6Title, instruction: T.mfgTask1Step6Instruction, action: { func: 'tutorial_highlightRange', args: [T.exampleTargetSheet, "A:G"] } }
            ];
            const checkpointStep = { isCheckpoint: true, title: T.mfgCheckpointTitle, instruction: T.mfgCheckpointInstruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } };
            tutorialSteps = [...importSteps, checkpointStep];
            checkpointIndex = tutorialSteps.findIndex(step => step.isCheckpoint);
        }

        function continueTutorial() {
            let nextSteps = [];
            const currentCheckpoint = tutorialSteps[currentStep];

            if (tutorialType === 'business') {
                if (currentCheckpoint.title === T.businessCheckpointTitle) {
                    nextSteps = [
                        { title: T.businessTask2Step1Title, instruction: T.businessTask2Step1Instruction, action: { func: 'tutorial_highlightRange', args: [T.exampleDashboardSheet_Sales, "C:E"] } },
                        { title: T.businessTask2Step2Title, instruction: T.businessTask2Step2Instruction.replace('{SOURCE_SHEET_NAME}', T.exampleCustomerMasterSheet_Sales).replace('{TARGET_SHEET_NAME}', T.exampleDashboardSheet_Sales), action: { func: 'tutorial_highlightSheet', args: [T.exampleCustomerMasterSheet_Sales] } },
                        { title: T.businessTask2Step3Title, instruction: T.businessTask2Step3Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } },
                        { title: T.businessTask3Step1Title, instruction: T.businessTask3Step1Instruction, action: { func: 'tutorial_highlightRange', args: [T.exampleDashboardSheet_Sales, "J:J"] } },
                        { title: T.businessTask3Step2Title, instruction: T.businessTask3Step2Instruction.replace('{SOURCE_SHEET_NAME}', T.exampleProductTargetsSheet_Sales), action: { func: 'tutorial_highlightSheet', args: [T.exampleProductTargetsSheet_Sales] } },
                        { title: T.businessFinalStepTitle, instruction: T.businessFinalStepInstruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } },
                        { isCheckpoint: true, title: T.businessCheckpoint2Title, instruction: T.businessCheckpoint2Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } }
                    ];
                } else if (currentCheckpoint.title === T.businessCheckpoint2Title) {
                    nextSteps = [
                        { title: T.businessTask4Step1Title, instruction: T.businessTask4Step1Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } },
                        { title: T.businessTask4Step2Title, instruction: T.businessTask4Step2Instruction.replace('{SHEET_NAME}', T.exampleDashboardSheet_Sales), action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } },
                        { title: T.businessTask4Step3Title, instruction: T.businessTask4Step3Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } },
                        { title: T.businessTask4Step4Title, instruction: T.businessTask4Step4Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] } },
                        { title: T.businessFinal2StepTitle, instruction: T.businessFinal2StepInstruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleDashboardSheet_Sales] }, isFinal: true }
                    ];
                }
            } else if (tutorialType === 'manufacturing') {
                 if (currentCheckpoint.title === T.mfgCheckpointTitle) {
                    nextSteps = [
                        { title: T.mfgTask2Step1Title, instruction: T.mfgTask2Step1Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } },
                        { title: T.mfgTask2Step2Title, instruction: T.mfgTask2Step2Instruction.replace('{SOURCE_SHEET_NAME}', T.exampleVerifySourceSheet), action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } },
                        { title: T.mfgTask2Step3Title, instruction: T.mfgTask2Step3Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleVerifySourceSheet] } },
                        { title: T.mfgTask2Step4Title, instruction: T.mfgTask2Step4Instruction, action: { func: 'tutorial_highlightRange', args: [T.exampleTargetSheet, "H:J"] } },
                        { title: T.mfgTask2FinalStepTitle, instruction: T.mfgTask2FinalStepInstruction, action: { func: 'tutorial_highlightRange', args: [T.exampleTargetSheet, "K:K"] } },
                        { isCheckpoint: true, title: T.mfgCheckpoint2Title, instruction: T.mfgCheckpoint2Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } }
                    ];
                 } else if (currentCheckpoint.title === T.mfgCheckpoint2Title) {
                    nextSteps = [
                        { title: T.mfgTask3Step1Title, instruction: T.mfgTask3Step1Instruction.replace('{SOURCE_SHEET_NAME}', T.exampleCompareSourceSheet), action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } },
                        { title: T.mfgTask3Step2Title, instruction: T.mfgTask3Step2Instruction, action: { func: 'tutorial_highlightSheet', args: [T.exampleTargetSheet] } },
                        { title: T.mfgTask3Step3Title, instruction: T.mfgTask3Step3Instruction.replace('{SOURCE_SHEET_NAME}', T.exampleCompareSourceSheet), action: { func: 'tutorial_highlightSheet', args: [T.exampleCompareSourceSheet] } },
                        { title: T.mfgFinalStepTitle, instruction: T.mfgFinalStepInstruction.replace('{SHEET_NAME}', T.exampleTargetSheet), action: { func: 'tutorial_highlightRange', args: [T.exampleTargetSheet, "L:L"] }, isFinal: true }
                    ];
                 }
            }

            tutorialSteps.splice(currentStep, 1, ...nextSteps);

            if (tutorialType === 'business') {
                checkpointIndex = tutorialSteps.findIndex(step => step.title === T.businessCheckpointTitle);
                businessCheckpoint2Index = tutorialSteps.findIndex(step => step.title === T.businessCheckpoint2Title);
            } else {
                checkpointIndex = tutorialSteps.findIndex(step => step.title === T.mfgCheckpointTitle);
                checkpoint2Index = tutorialSteps.findIndex(step => step.title === T.mfgCheckpoint2Title);
            }

            populateStepSelector();
            renderStep(currentStep);
        }

        function returnToCheckpoint() {
            if (checkpointIndex !== -1) {
                currentStep = checkpointIndex;
                renderStep(currentStep);
            }
        }

        function returnToStep13() {
            // Find step 13 (businessFinalStepTitle)
            const step13Index = tutorialSteps.findIndex(step => step.title === T.businessFinalStepTitle);
            if (step13Index !== -1) {
                currentStep = step13Index;
                renderStep(currentStep);
            } else {
                console.warn('Step 13 not found, falling back to returnToCheckpoint');
                returnToCheckpoint();
            }
        }

        function endTutorial() {
            const currentStepTitle = tutorialSteps[currentStep].title;
            let returnButtonHtml = '';

            // Dynamic button logic
            if (tutorialType === 'business' && currentStepTitle === T.businessCheckpoint2Title) {
                returnButtonHtml = `<button onclick="returnToStep13()" class="choice-button bg-slate-200 hover:bg-slate-300 text-slate-700">${T.businessReturnToStep13}</button>`;
            } else {
                returnButtonHtml = `<button onclick="returnToCheckpoint()" class="choice-button bg-slate-200 hover:bg-slate-300 text-slate-700">${T.endTutorialReturnButton}</button>`;
            }

            const contentDiv = document.getElementById('step-content');
            contentDiv.innerHTML = `
                <h2 class="step-title">${T.endTutorialTitle}</h2>
                <p class="step-instruction">${T.endTutorialInstruction.replace(/\n/g, '<br>')}</p>
                <div class="mt-6 space-y-3">
                    ${returnButtonHtml}
                </div>
            `;
            document.getElementById('nav-buttons').style.display = 'none';
        }

        function handleInsertFormulas() {
            const btn = document.getElementById('insert-formulas-btn');
            if(btn) {
                btn.disabled = true;
                btn.textContent = T.businessProcessingButton || 'Processing...';

                // For manual action, we also show the loading indicator but maybe keep it separate from the auto-step actions
                // Or we can reuse startLoadingAnimation but we need to ensure it doesn't conflict with step navigation.
                // Given the context, this button is a manual user trigger within a step.
                // Let's use the loading animation for consistency.
                startLoadingAnimation();

                google.script.run
                    .withSuccessHandler(() => {
                        stopLoadingAnimation();
                        btn.textContent = T.businessSuccessButton || 'Formulas Inserted!';
                        google.script.run.tutorial_highlightRange(T.exampleDashboardSheet_Sales, "G:K");
                    })
                    .withFailureHandler((err) => {
                        stopLoadingAnimation();
                        btn.textContent = T.businessErrorButton || 'Error, please retry';
                        btn.disabled = false;
                        alert(err);
                    })
                    .insertSalesMetricsFormulas();
            }
        }

        function startLoadingAnimation() {
            const indicator = document.getElementById('loading-indicator');
            const bar = document.getElementById('loading-bar');
            const percentText = document.getElementById('loading-percent');
            const loadingText = document.getElementById('loading-text');

            if (indicator && bar && percentText) {
                indicator.classList.remove('hidden');
                loadingText.textContent = T.businessProcessingButton || 'Processing...';

                let percent = 0;
                bar.style.width = '0%';
                percentText.textContent = '0%';

                if (loadingInterval) clearInterval(loadingInterval);

                loadingInterval = setInterval(() => {
                    if (percent < 95) {
                        // Slow down as it gets higher
                        const increment = Math.max(1, (95 - percent) / 10);
                        percent += increment;
                        bar.style.width = percent + '%';
                        percentText.textContent = Math.round(percent) + '%';
                    }
                }, 100);
            }
        }

        function stopLoadingAnimation() {
            if (loadingInterval) clearInterval(loadingInterval);

            const indicator = document.getElementById('loading-indicator');
            const bar = document.getElementById('loading-bar');
            const percentText = document.getElementById('loading-percent');

            if (indicator && bar && percentText) {
                bar.style.width = '100%';
                percentText.textContent = '100%';

                setTimeout(() => {
                    indicator.classList.add('hidden');
                    bar.style.width = '0%';
                    percentText.textContent = '0%';
                }, 500);
            }
        }

        function renderStep(stepIndex) {
            const step = tutorialSteps[stepIndex];
            if (!step) return;

            const contentDiv = document.getElementById('step-content');
            const navButtons = document.getElementById('nav-buttons');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const selector = document.getElementById('step-selector');
            contentDiv.style.opacity = 0;

            setTimeout(() => {
                if (step.isCheckpoint) {
                    contentDiv.innerHTML = `<h2 class="step-title">${step.title}</h2><p class="step-instruction">${step.instruction.replace(/\n/g, '<br>')}</p><div class="mt-6 space-y-3"><button onclick="continueTutorial()" class="choice-button bg-blue-600 hover:bg-blue-700 text-white">${T.tutorialYes}</button><button onclick="endTutorial()" class="choice-button bg-slate-200 hover:bg-slate-300 text-slate-700">${T.tutorialNo}</button></div>`;
                    navButtons.style.display = 'none';
                    selector.style.display = 'none';
                } else {
                    contentDiv.innerHTML = `<h2 class="step-title">${step.title}</h2><p class="step-instruction">${step.instruction.replace(/\n/g, '<br>')}</p>`;
                    if (step.title === T.businessFinalStepTitle && tutorialType === 'business') {
                         contentDiv.innerHTML += `<div class="mt-4"><button id="insert-formulas-btn" onclick="handleInsertFormulas()" class="choice-button bg-green-600 hover:bg-green-700 text-white">${T.businessFinalStepButton}</button></div>`;
                    }
                    navButtons.style.display = 'flex';
                    selector.style.display = 'block';
                }

                if (step.isFinal) {
                    nextBtn.textContent = T.tutorialClose;
                    prevBtn.style.display = 'inline-flex';
                } else {
                    prevBtn.textContent = T.tutorialPrev;
                    nextBtn.textContent = T.tutorialNext;
                    prevBtn.style.display = 'inline-flex';
                }

                contentDiv.style.opacity = 1;
            }, 200);

            const progress = ((stepIndex + 1) / tutorialSteps.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';

            document.getElementById('progress-text').textContent = T.tutorialProgressText
                .replace('{CURRENT}', stepIndex + 1)
                .replace('{TOTAL}', tutorialSteps.length);

            selector.value = stepIndex;

            prevBtn.disabled = stepIndex === 0;
            nextBtn.disabled = step.isCheckpoint;

            if (step.action && step.action.func) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                selector.disabled = true;

                startLoadingAnimation();

                const onActionComplete = () => {
                    stopLoadingAnimation();
                    prevBtn.disabled = stepIndex === 0;
                    nextBtn.disabled = step.isCheckpoint;
                    selector.disabled = false;
                };

                const runner = google.script.run
                    .withSuccessHandler(onActionComplete)
                    .withFailureHandler(onActionComplete);

                runner[step.action.func].apply(null, step.action.args || []);
            }
        }
    </script>
</body>
</html>
